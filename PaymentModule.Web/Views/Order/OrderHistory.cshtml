@model List<PaymentModule.Data.Entities.OrderTable>
@using PaymentModule.Data.Entities
@{
    ViewData["Title"] = "Purchase History";
    Layout = "~/Views/Shared/_Layout.cshtml";

    // Helper function để lấy text trạng thái
    string GetStatusText(OrderTable order)
    {
        var shipping = order.ShippingInfos.OrderByDescending(s => s.Id).FirstOrDefault();
        if (shipping != null)
        {
            switch (shipping.Status)
            {
                case ShippingStatusConstants.Processing: return "Đang xử lý";
                case ShippingStatusConstants.InTransit: return "Đang vận chuyển";
                case ShippingStatusConstants.Delivered: return "Đã giao";
                case ShippingStatusConstants.Failed: return "Giao thất bại";
                case ShippingStatusConstants.Cancelled: return "Đã hủy";
            }
        }
        return order.Status; // Trạng thái gốc (Processing, Shipping_Failed)
    }

    // Helper function để lấy class CSS
    string GetStatusClass(OrderTable order)
    {
        
        var shipping = order.ShippingInfos.OrderByDescending(s => s.Id).FirstOrDefault();
        if (shipping != null)
        {
             switch (shipping.Status)
            {
                case ShippingStatusConstants.InTransit: return "shipped";
                case ShippingStatusConstants.Delivered: return "delivered";
            }
        }
        return "default";
    }
}

<section class="order-history">
    <h2>Purchase History</h2>

    <div class="order-list">
        @if (Model == null || !Model.Any())
        {
            <p>Bạn chưa có đơn hàng nào.</p>
        }
        else
        {
            @foreach (var order in Model)
            {
                var shipping = order.ShippingInfos.OrderByDescending(s => s.Id).FirstOrDefault();
                <div class="order-card">
                    <div class="order-info">
                        <p><strong>Order #@order.Id</strong></p>
                        <p>Ngày đặt: @order.OrderDate.Value.ToLocalTime().ToString("dd/MM/yyyy")</p>
                        <p>Trạng thái: <span class="status @GetStatusClass(order)">@GetStatusText(order)</span></p>
                        <p>Tổng tiền: $@order.TotalPrice.Value.ToString("N0")</p>
                    </div>
                    <div class="order-actions">
                        @if (shipping != null)
                        {
                            <a href="/order/OrderTracking/@order.Id" class="btn btn-outline">Theo dõi đơn hàng</a>
                        }
                        else
                        {
                            <a href="#" class="btn btn-outline disabled" aria-disabled="true">Chưa có vận đơn</a>
                        }
                    </div>
                </div>
            }
        }
    </div>
</section>

<style>
    .status.shipped { color: #0064d2; font-weight: 600; }
    .status.delivered { color: #00a650; font-weight: 600; }
    .status.default { color: #555; font-weight: 600; }
    .btn-outline.disabled {
        border-color: #ccc;
        color: #ccc;
        pointer-events: none;
    }
    .order-history {
        max-width: 900px;
        margin: 40px auto;
        padding: 0 20px;
    }

    .order-list {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .order-card {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid #ddd;
        padding: 16px 20px;
        border-radius: 10px;
        background: #fff;
    }

    .status.shipped {
        color: #0064d2;
        font-weight: 600;
    }

    .status.delivered {
        color: #00a650;
        font-weight: 600;
    }

    .btn-outline {
        border: 1px solid #0064d2;
        color: #0064d2;
        border-radius: 30px;
        padding: 6px 14px;
        font-weight: 500;
        text-decoration: none;
    }

        .btn-outline:hover {
            background: #0064d2;
            color: #fff;
        }
</style>
