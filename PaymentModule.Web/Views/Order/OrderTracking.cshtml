@model PaymentModule.Data.Entities.OrderTable
@using PaymentModule.Data.Entities 
@{
    ViewData["Title"] = "Order Tracking";
    Layout = "~/Views/Shared/_Layout.cshtml";

    // Lấy thông tin vận đơn ra cho dễ dùng
    var shippingInfo = Model.ShippingInfos.OrderByDescending(s => s.Id).FirstOrDefault();

    @if (shippingInfo == null)
    {
        <p>Không tìm thấy thông tin vận đơn.</p>
        return; 
    }

    // Logic quyết định timeline
    bool confirmed = true; // Luôn luôn
    bool processing = shippingInfo.Status == ShippingStatusConstants.Processing || 
                      shippingInfo.Status == ShippingStatusConstants.InTransit || 
                      shippingInfo.Status == ShippingStatusConstants.Delivered;
                      
    bool inTransit = shippingInfo.Status == ShippingStatusConstants.InTransit || 
                     shippingInfo.Status == ShippingStatusConstants.Delivered;
                     
    bool delivered = shippingInfo.Status == ShippingStatusConstants.Delivered;

    bool failed = shippingInfo.Status == ShippingStatusConstants.Failed;
}

<section class="order-tracking-page">
    <div class="tracking-container">
        <h2 class="page-title">Theo dõi đơn hàng</h2>

        <div class="tracking-header">
            <p>Mã đơn hàng: <strong>#@Model.Id</strong></p>
            <p>Mã vận đơn: <strong>@shippingInfo.TrackingNumber</strong></p>
            <p>Đơn vị vận chuyển: <strong>@shippingInfo.Carrier</strong></p>
        </div>

        @if (failed)
        {
            <div class="tracking-timeline">
                <div class="step failed active"> <div class="circle"></div>
                    <div class="content">
                        <h4>Giao hàng thất bại</h4>
                        <p>Đã xảy ra lỗi trong quá trình vận chuyển. Vui lòng liên hệ hỗ trợ.</p>
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="tracking-timeline">
                <div class="step @(confirmed ? "completed" : "")">
                    <div class="circle"></div>
                    <div class="content">
                        <h4>Đơn hàng đã được xác nhận</h4>
                        <p>@Model.OrderDate.Value.ToLocalTime().ToString("dd/MM/yyyy - HH:mm")</p>
                    </div>
                </div>

                <div class="step @(processing ? "completed" : "") @(shippingInfo.Status == ShippingStatusConstants.Processing ? "active" : "")">
                    <div class="circle"></div>
                    <div class="content">
                        <h4>Đang xử lý & đóng gói</h4>
                        <p>@(!processing ? "Chưa cập nhật" : "Đang chuẩn bị hàng cho vận chuyển...")</p>
                    </div>
                </div>

                <div class="step @(inTransit ? "completed" : "") @(shippingInfo.Status == ShippingStatusConstants.InTransit ? "active" : "")">
                    <div class="circle"></div>
                    <div class="content">
                        <h4>Đơn hàng đang được vận chuyển</h4>
                        <p>@(!inTransit ? "Chưa cập nhật" : $"Dự kiến giao: {shippingInfo.EstimatedArrival?.ToLocalTime().ToString("dd/MM/yyyy")}")</p>
                    </div>
                </div>

                <div class="step @(delivered ? "completed active" : "")">
                    <div class="circle"></div>
                    <div class="content">
                        <h4>Đã giao hàng thành công</h4>
                        <p>@(!delivered ? "Chưa cập nhật" : "Giao hàng thành công!")</p>
                    </div>
                </div>
            </div>
        }

        <div class="tracking-action">
            @if (!delivered && !failed)
            {
                <form asp-controller="Order" asp-action="SyncShippingStatus" asp-route-id="@Model.Id" method="post" style="display: inline-block; margin-right: 15px;">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="btn-sync">Làm mới trạng thái</button>
                </form>
            }
            <a href="/order/OrderHistory" class="btn-back">← Quay lại lịch sử</a>
        </div>
    </div>
</section>

<style>
    .tracking-container {
        max-width: 800px;
        margin: 40px auto;
        padding: 20px;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }

    .page-title {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 20px;
    }

    .tracking-header {
        background: #fafafa;
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 15px 20px;
        margin-bottom: 30px;
    }

    .tracking-timeline {
        position: relative;
        margin-left: 30px;
    }

    .step {
        display: flex;
        align-items: flex-start;
        position: relative;
        margin-bottom: 25px;
    }

    .circle {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #ccc;
        margin-right: 16px;
        position: relative;
        top: 4px;
    }

    .step::before {
        content: "";
        position: absolute;
        left: 7px;
        top: 20px;
        width: 2px;
        height: 100%;
        background: #ddd;
    }

    .step.completed .circle {
        background: #00a650;
    }

    .step.active .circle {
        background: #0064d2;
    }

    .step:last-child::before {
        display: none;
    }

    .content h4 {
        margin: 0;
        font-weight: 600;
    }

    .content p {
        margin: 4px 0 0 0;
        color: #777;
        font-size: 14px;
    }

    .tracking-action {
        text-align: center;
        margin-top: 30px;
    }

    .btn-back {
        background: #0064d2;
        color: #fff;
        padding: 12px 24px;
        border-radius: 30px;
        text-decoration: none;
        font-weight: 600;
    }

        .btn-back:hover {
            background: #0654ba;
        }

    .step.failed .circle {
        background: #d90000; /* Màu đỏ cho failed */
    }
    .step.failed.active .content h4 {
        color: #d90000;
    }
    
    .btn-back {
        background: #0064d2;
        color: #fff;
        padding: 12px 24px;
        border-radius: 30px;
        text-decoration: none;
        font-weight: 600;
        display: inline-block; /* Thêm */
    }

    .btn-sync {
        background: #00a650; /* Màu xanh lá */
        color: #fff;
        padding: 12px 24px;
        border-radius: 30px;
        text-decoration: none;
        font-weight: 600;
        border: none;
        cursor: pointer;
        font-family: inherit; /* Thêm */
        font-size: inherit; /* Thêm */
    }

    .btn-sync:hover {
        background: #008c43;
    }
</style>
